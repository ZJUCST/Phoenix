/**
 * Created with IntelliJ IDEA.
 * User: zmzsmnh
 * Date: 12-12-19
 * Time: 下午2:21
 * To change this template use File | Settings | File Templates.
 */

var request = require('request'),
    wsconf = require('./../../conf/upyunWS.conf.json');

var uploadUrl = wsconf.server + '/upload';
var deleteUrl = wsconf.server + '/delete';

/**
 * Upload image to upyun and get upyun url
 * @param {string} uri - uri of Image on Internet or on user computer
 * @param {Buffer} data - Image content, leave it null if upload image on Internet
 * @param {Function(error, response, uri)} fn - callback function
 * @api public
 */
exports.upload = function (uri, data, fn) {
    var length = 0;
    if(data && data !=null)
        length = data.length + wsconf.token.length + uri.length + 363;
    var req = request.post(uploadUrl, {headers: {'Content-Length': length}}, function (err, res, body) {
        if (err) {
            fn(err, res, null);
        } else {
            fn(err, res, body);
        }
    });
    var form = req.form();
    form.append('token', wsconf.token);
    form.append('uri', uri);
    if (data) {
        form.append('data', new Buffer(data, 'binary'));
    }
}

/**
 * Delete image on upyun server
 * @param {string} uri - image uri on upyun
 * @param {Function(error, body)} fn - callback function
 */
exports.delete = function (uri, fn) {
    var formData = {
        token:wsconf.token,
        uri:uri
    };
    request.del(deleteUrl, {form:formData}, function (err, res, body) {
        if (err) {
            fn(err, null);
        } else {
            fn(err, body);
        }
    });
}