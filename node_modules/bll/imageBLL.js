/**
 * Created with IntelliJ IDEA.
 * User: zmzsmnh
 * Date: 12-12-21
 * Time: 下午3:44
 * To change this template use File | Settings | File Templates.
 */

var events = require('events'),
    imageDAL = require('dal').Image;
    upyunws = require('util/upyunws'),
    fs = require('fs');

var imageEvent = new events.EventEmitter();
imageEvent.on('upyun', function (image, content, tryTimes) {
    if(tryTimes > 10) {
        SLOG.error("Upload to upyun error: ", err);
        imageEvent.emit('save', image);
        return;
    }
    SLOG.trace("Upload image to upyun: ", image.orgin);
    upyunws.upload(image.orgin, content, function (err, res, upyunUrl) {
        if (err) {
            SLOG.error("Upload to upyun error: ", err);
        } else if (res.statusCode == 403) {
            imageEvent.emit('upyun', image, content, tryTimes+1);
            return;
        } else {
            image.url = upyunUrl;
            image.isPending = false;
            SLOG.trace("Uploaded: ", upyunUrl);
        }
        imageEvent.emit('save', image);
    });
});

imageEvent.on('save', function(image) {
     imageDAL.insert(image, {safe: true}, function(err, records) {
         imageDAL.findAllAndsortByCreateTime(function(err, records) {
            console.log(records);
         })
     });
});

var constructImage = function (req) {
    var image = {};
    image.uid = req.session.user.id;
    image.orgin = req.body.uri;
    image.from = req.body.from ? req.body.from : '';
    image.tags = req.body.tags ? req.body.tags : '';
    image.description = req.body.description ? req.body.description : '';
    image.isPending = true;
    image.createTime = new Date();
    return image;
}

exports.collect = function (req, res) {
    var image = constructImage(req);
    imageEvent.emit('upyun', image, null, 1);
    res.send();
}

exports.upload = function(req, res) {
    var image = constructImage(req);
    image.orgin = req.files.image_upload.name;
    fs.readFile(req.files.Filedata.path, function(err, data) {
        imageEvent.emit('upyun', image, data, 1);
        res.send();
    });
}